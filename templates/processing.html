<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Auto Backlog & Jira Processing</title>

<style>
  body {
    font-family: "Inter", "Segoe UI", Arial, sans-serif;
    background: linear-gradient(145deg, #eef2f7, #f9fbfd);
    color: #1b263b;
    text-align: center;
    padding: 40px;
  }

  .loader {
    border: 6px solid #f3f3f3;
    border-top: 6px solid #00796b;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }
  @keyframes spin { 100% { transform: rotate(360deg); } }

  h2 {
    font-weight: 700;
    margin-bottom: 24px;
    color: #0f3057;
    letter-spacing: 0.3px;
  }

  #resultBox {
    display: none;
    max-width: 900px;
    margin: 24px auto;
    text-align: left;
  }

  /* ==== ITEM CARD ==== */
  .jira-item {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.06);
    padding: 10px 42px;
    margin-bottom: 32px;
    border: 2px solid #00796b;
    transition: all 0.2s ease-in-out;
    position: relative;
  }

  .jira-item:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  }

  .jira-id {
    position: absolute;
    top: -12px;
    right: 16px;
    background: #e0f2f1;
    color: #004d40;
    font-weight: 600;
    font-size: 13px;
    padding: 4px 10px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
  }

  .section-title {
    font-weight: 600;
    color: #004d40;
    font-size: 14px;
    margin-bottom: 6px;
    margin-top: 10px;
    display: block;
  }

  input, textarea {
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #d0d7de;
    margin-bottom: 12px;
    font-family: inherit;
    font-size: 14px;
    color: #212529;
    background-color: #f9fbfc;
    transition: border-color 0.2s ease, background 0.2s ease;
  }

  input:focus, textarea:focus {
    outline: none;
    border-color: #00796b;
    background: #fff;
    box-shadow: 0 0 0 2px rgba(0,121,107,0.1);
  }

  textarea {
    resize: vertical;
    min-height: 60px;
  }

  button {
    margin-top: 28px;
    padding: 12px 28px;
    border: none;
    border-radius: 8px;
    background: linear-gradient(135deg, #00796b, #004d40);
    color: #ffffff;
    font-weight: 600;
    cursor: pointer;
    font-size: 15px;
    letter-spacing: 0.3px;
    transition: all 0.25s ease;
  }
  button:hover {
    background: linear-gradient(135deg, #009688, #00695c);
    transform: translateY(-2px);
  }

  /* Label group for nicer alignment */
  .jira-fields {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
  }

  @media (min-width: 700px) {
    .jira-fields {
      grid-template-columns: 1fr 1fr;
      gap: 16px 20px;
    }
    textarea {
      grid-column: span 2;
    }
  }

</style>
</head>

<body>
  <div id="loader" class="loader"></div>
  <h2 id="statusText">ƒêang t·∫°o danh s√°ch User Story...</h2>

  <div id="resultBox"></div>

  <div style="margin-top:28px;">
    <button id="nextBtn" style="display:none;">üíæ ƒê·∫©y to√†n b·ªô User Story l√™n Jira</button>
  </div>

  <div style="margin-top:18px;">
    <button id="nextBtnStep3" style="display:none;">üíæ ƒê·∫©y to√†n b·ªô Task/SubTask l√™n Jira</button>
  </div>

  <script>

    const payload = {
      epic_name: {{ epic|tojson }},
      business_goal: {{ goal|tojson }},
      high_level_desc: {{ desc|tojson }},
      requirement_type: {{ requirement|tojson }}
    };

    let currentStep = 1;
    let currentItems = [];

    async function runStep(step) {
      const loader = document.getElementById("loader");
      const nextBtn = document.getElementById("nextBtn");
      const nextBtnStep3 = document.getElementById("nextBtnStep3");
      const status = document.getElementById("statusText");
      const box = document.getElementById("resultBox");

      loader.style.display = "block";
      nextBtn.style.display = "none";
      nextBtnStep3.style.display = "none";
      box.style.display = "none";

             stepContentTitle =
    step === 1 ? "ƒêang t·∫°o dach s√°ch User Story..." :
    step === 2 ? "ƒêang ƒë·∫©y to√†n b·ªô User Story l√™n Jira..." :
    step === 3 ? "ƒêang t·∫°o dach s√°ch Task/SubTask..." :
    step === 4 ? "ƒêang ƒë·∫©y to√†n b·ªô Task/SubTask l√™n Jira..." :
    step === 5 ? "ƒêang t·∫°o k·∫ø ho·∫°ch v√† kh√°i to√°n tr√™n Confluence..." :
      "Qu√° tr√¨nh ƒë√£ ho√†n t·∫•t. H√£y truy c·∫≠p Workspace tr√™n Jira ƒë·ªÉ xem nh·ªØng n·ªôi dung m·ªõi t·∫°o";

      status.textContent = stepContentTitle;

      try {
        const res = await fetch("/run_step", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({...payload, step})
        });
        const data = await res.json();

        loader.style.display = "none";

        if (data.status === "success") {
  currentItems = data.result;
  if (data.step === 1) {
    nextBtn.style.display = "inline-block";
    status.textContent = "K·∫øt qu·∫£ Step 1: " + currentItems.length + " User Story ƒë∆∞·ª£c t·∫°o";
    if (currentItems.length > 0) renderItems(currentItems);
  }
  if (data.step === 2){skipToNetxtStep();}
  else if (data.step === 3) {
    nextBtnStep3.style.display = "inline-block";
    status.textContent = "K·∫øt qu·∫£ Step 3: " + currentItems.length + " Task/Subtask Preview ƒë∆∞·ª£c t·∫°o";
    if (currentItems.length > 0) renderSubTask(currentItems);
  }
  if (data.step === 4){skipToNetxtStep();}
  else
    // status.textContent = "ƒê√£ ho√†n th√†nh Step " + data.step;

       stepContent =
    data.step === 1 ? "Danh s√°ch User Story Preview" :
    data.step === 3 ? "Danh s√°ch Sub Task Preview" :
      "Qu√° tr√¨nh ƒë√£ ho√†n t·∫•t. H√£y truy c·∫≠p Workspace tr√™n Jira ƒë·ªÉ xem nh·ªØng n·ªôi dung m·ªõi t·∫°o";

      status.textContent = stepContent;

        } else {
          status.textContent = "‚ùå XXX L·ªói: " + data.message;
        }
      } catch (err) {
        loader.style.display = "none";
        status.textContent = "‚ùå L·ªói k·∫øt n·ªëi: " + err.message;
      }

    }

    function renderItems(items) {
      const box = document.getElementById("resultBox");
      box.innerHTML = "";
      box.style.display = "block";

      items.forEach((it, idx) => {
        const el = document.createElement("div");
        el.className = "jira-item";
        el.innerHTML = `
          <div class="jira-id">#${it.uid || (idx + 1)}</div>

          <label class="section-title">Title</label>
          <input type="text" id="title-${idx}" value="${escapeHtml(it.title)}">

          <label class="section-title">Description</label>
          <textarea id="content-${idx}" rows="4">${escapeHtml(it.content)}</textarea>

          <label class="section-title">Acceptance Criteria</label>
          <textarea id="criteria-${idx}" rows="3">${escapeHtml(it.criteria)}</textarea>
        `;
        box.appendChild(el);
      });
    }

    function renderSubTask(items) {
      const box = document.getElementById("resultBox");
      box.innerHTML = "";
      box.style.display = "block";

      items.forEach((it, idx) => {
        const el = document.createElement("div");
        el.className = "jira-item";
        el.innerHTML = `
          <div class="jira-id">#${it.uid || (idx + 1)}</div>

          <label class="section-title">Title SubTask</label>
          <input type="text" id="title-${idx}" value="${escapeHtml(it.title)}">

          <label class="section-title">Description SubTask</label>
          <textarea id="content-${idx}" rows="4">${escapeHtml(it.content)}</textarea>

        `;
        box.appendChild(el);
      });
    }

    // Escape ƒë·ªÉ tr√°nh ph√° v·ª° HTML khi render gi√° tr·ªã c√≥ k√Ω t·ª± ƒë·∫∑c bi·ªát
    function escapeHtml(str) {
      if (str == null) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }


async function skipToNetxtStep() {
  currentStep++;
  await new Promise(resolve => setTimeout(resolve, 500));
  runStep(currentStep);
}


    async function createUserStoryStep() {
     // Thu th·∫≠p theo INDEX ƒë·ªÉ tr√°nh v·∫•n ƒë·ªÅ uid r·ªóng
      const updated = currentItems.map((it, idx) => ({
        // uid c√≥ th·ªÉ r·ªóng ·ªü step 1; backend ƒëang map theo index n√™n kh√¥ng c·∫ßn uid
        title: document.getElementById(`title-${idx}`).value.trim(),
        content: document.getElementById(`content-${idx}`).value.trim(),
        criteria: document.getElementById(`criteria-${idx}`).value.trim()
      }));

      try {
        // 1) L∆∞u t·∫•t c·∫£ theo index
        const res = await fetch("/update_all_items", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({items: updated})
        });
        const data = await res.json();

        if (data.status === "success") {

          currentStep++;
          if (currentStep <= 5) {
            runStep(currentStep);
          } else {
            document.getElementById("statusText").textContent = "üéâ Ho√†n t·∫•t to√†n b·ªô 5 b∆∞·ªõc!";
            document.getElementById("nextBtnStep3").style.display = "none";
          }
        } else {
          alert("‚ùå L·ªói ZZZ: " + data.message);
        }

      } catch (err) {
        alert("‚ùå L·ªói k·∫øt n·ªëi: " + err.message);
      }
}



    async function createSubTaskStep() {
      // Thu th·∫≠p theo INDEX ƒë·ªÉ tr√°nh v·∫•n ƒë·ªÅ uid r·ªóng
      const updated = currentItems.map((it, idx) => ({
        // uid c√≥ th·ªÉ r·ªóng ·ªü step 1; backend ƒëang map theo index n√™n kh√¥ng c·∫ßn uid
        title: document.getElementById(`title-${idx}`).value.trim(),
        content: document.getElementById(`content-${idx}`).value.trim()
      }));

      try {
        // 1) L∆∞u t·∫•t c·∫£ theo index
        const res = await fetch("/update_all_sub_tasks", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({items: updated})
        });
        const data = await res.json();

        if (data.status === "success") {
          // 2) Chuy·ªÉn b∆∞·ªõc
          currentStep++;
          if (currentStep <= 5) {
            runStep(currentStep);
          } else {
            document.getElementById("statusText").textContent = "üéâ Ho√†n t·∫•t to√†n b·ªô 5 b∆∞·ªõc!";
            document.getElementById("nextBtnStep3").style.display = "none";
          }
        } else {
          alert("‚ùå L·ªói ZZZ: " + data.message);
        }
      } catch (err) {
        alert("‚ùå L·ªói k·∫øt n·ªëi: " + err.message);
      }
}

    document.getElementById("nextBtn").addEventListener("click", async () => {createUserStoryStep();});
    document.getElementById("nextBtnStep3").addEventListener("click", async () => { createSubTaskStep();});

    // Auto ch·∫°y Step 1 khi load
    runStep(1);
</script>
</body>
</html>
